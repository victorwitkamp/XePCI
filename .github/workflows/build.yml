name: Build XePCI (stand-alone PCI kext)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-release:
    name: Release build
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install MacKernelSDK
        run: |
          git clone --depth=1 https://github.com/acidanthera/MacKernelSDK.git /tmp/MacKernelSDK
          sudo mkdir -p /Library/Developer/SDKs
          sudo cp -R /tmp/MacKernelSDK /Library/Developer/SDKs/

      - name: Verify toolchain
        run: |
          clang++ --version
          xcode-select -p
          ls -la /Library/Developer/SDKs/MacKernelSDK

      - name: Build (Release)
        env:
          KERNEL_SDK: /Library/Developer/SDKs/MacKernelSDK
        run: |
          make clean
          make release KERNEL_SDK=$KERNEL_SDK ARCH=x86_64
          test -f build/XePCI.kext/Contents/MacOS/XePCI

      # --- Stage so the artifact contains XePCI.kext at the top level ---
      - name: Stage artifact (Release)
        run: |
          rm -rf dist/release
          mkdir -p dist/release
          cp -R build/XePCI.kext dist/release/XePCI.kext
          ls -la dist/release

      - name: Upload artifact (Release)
        uses: actions/upload-artifact@v4
        with:
          name: XePCI-${{ github.sha }}-release
          path: dist/release
          if-no-files-found: error
          retention-days: 30

      - name: Summary
        if: success()
        run: |
          {
            echo "## Build Summary";
            echo "- Target: Release";
            echo "- SDK: MacKernelSDK";
            echo "- Arch: x86_64";
            echo "- Artifact root contains: XePCI.kext";
          } >> "$GITHUB_STEP_SUMMARY"

  build-debug:
    name: Debug build
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install MacKernelSDK
        run: |
          git clone --depth=1 https://github.com/acidanthera/MacKernelSDK.git /tmp/MacKernelSDK
          sudo mkdir -p /Library/Developer/SDKs
          sudo cp -R /tmp/MacKernelSDK /Library/Developer/SDKs/

      - name: Build (Debug)
        env:
          KERNEL_SDK: /Library/Developer/SDKs/MacKernelSDK
        run: |
          make clean
          make debug KERNEL_SDK=$KERNEL_SDK ARCH=x86_64
          test -f build/XePCI.kext/Contents/MacOS/XePCI
          dsymutil build/XePCI.kext/Contents/MacOS/XePCI || true

      - name: Stage artifact (Debug)
        run: |
          rm -rf dist/debug
          mkdir -p dist/debug
          cp -R build/XePCI.kext dist/debug/XePCI.kext
          # Optional: include dSYM in the same artifact
          if [ -d build/XePCI.kext.dSYM ]; then cp -R build/XePCI.kext.dSYM dist/debug/XePCI.kext.dSYM; fi
          ls -la dist/debug

      - name: Upload artifact (Debug)
        uses: actions/upload-artifact@v4
        with:
          name: XePCI-${{ github.sha }}-debug
          path: dist/debug
          if-no-files-found: error
          retention-days: 30
