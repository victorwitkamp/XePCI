name: Build XePCI (stand-alone PCI kext)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-release:
    name: Release build
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install MacKernelSDK
        run: |
          git clone --depth=1 https://github.com/acidanthera/MacKernelSDK.git /tmp/MacKernelSDK
          sudo mkdir -p /Library/Developer/SDKs
          sudo cp -R /tmp/MacKernelSDK /Library/Developer/SDKs/
          echo "SDKs:"; ls -la /Library/Developer/SDKs/

      - name: Verify toolchain
        run: |
          clang++ --version
          xcode-select -p
          ls -la /Library/Developer/SDKs/MacKernelSDK

      - name: Build (Release)
        env:
          KERNEL_SDK: /Library/Developer/SDKs/MacKernelSDK
        run: |
          make clean
          make release KERNEL_SDK=$KERNEL_SDK ARCH=x86_64
          test -f build/XePCI.kext/Contents/MacOS/XePCI

      - name: Package artifact
        run: |
          cd build
          zip -r XePCI-release-${{ github.sha }}.zip XePCI.kext
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: XePCI-release-${{ github.sha }}
          path: build/XePCI-release-*.zip
          retention-days: 30

      - name: Summary
        if: success()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Target: Release" >> $GITHUB_STEP_SUMMARY
          echo "- SDK: MacKernelSDK" >> $GITHUB_STEP_SUMMARY
          echo "- Arch: x86_64 (cross-compiled)" >> $GITHUB_STEP_SUMMARY

  build-debug:
    name: Debug build
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install MacKernelSDK
        run: |
          git clone --depth=1 https://github.com/acidanthera/MacKernelSDK.git /tmp/MacKernelSDK
          sudo mkdir -p /Library/Developer/SDKs
          sudo cp -R /tmp/MacKernelSDK /Library/Developer/SDKs/

      - name: Build (Debug)
        env:
          KERNEL_SDK: /Library/Developer/SDKs/MacKernelSDK
        run: |
          make clean
          make debug KERNEL_SDK=$KERNEL_SDK ARCH=x86_64
          test -f build/XePCI.kext/Contents/MacOS/XePCI
          # Optional: produce dSYM (not strictly needed for kext, but handy)
          dsymutil build/XePCI.kext/Contents/MacOS/XePCI || true

      - name: Package artifact
        run: |
          cd build
          zip -r XePCI-debug-${{ github.sha }}.zip XePCI.kext
          cd ..

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: XePCI-debug-${{ github.sha }}
          path: build/XePCI-debug-*.zip
          retention-days: 30
